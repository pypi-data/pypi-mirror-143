{% extends 'oscar/dashboard/layout.html' %}
{% load i18n %}
{% load thumbnail %}


{% block extrastyles %}
  {{ block.super }}
  <style>
    .select2-container{
      width:100%!important;
    }
  </style>
{% endblock %}


{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">{% trans "Dashboard" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:offer-list' %}">{% trans "Offers" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:offer-detail' pk=offer.pk %}">{{ offer.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:product-offer-list' offer_pk=offer.pk %}">{% trans 'Special prices and display options' %}</a></li>
            {% if form.instance.pk %}
              <li class="breadcrumb-item">
                <a href="{% url 'dashboard:product-offer-detail' offer_pk=offer.pk pk=form.instance.pk %}">
                  {% if form.instance.get_title %}
                    {{ form.instance.get_title }}
                  {% else %}
                    Element
                  {% endif %}
                </a>
              </li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{% if form.instance.pk %}{% trans 'Edit' %}{% else %}{% trans "Create" %}{% endif %}</li>
        </ol>
    </nav>
{% endblock %}


{% block header %}
  <div class="page-header">
    {% if form.instance.pk %}
      <a
        class="btn btn-danger float-right mr-2"
        href="{% url 'dashboard:product-offer-delete' offer_pk=offer.pk pk=form.instance.pk %}">
          {% trans "Delete" %}
      </a>
      <button class="btn btn-secondary float-right mr-2" onclick="reloadPreview();">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
          <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
          <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
        </svg>
      </button>
      {% if form.instance.cached_slide %}
        <a
          class="btn btn-primary float-right mr-2"
          href="{% url 'dashboard:slide' range_product_pk=form.instance.pk suffix='png' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
        </a>
      {% endif %}
    {% endif %}
    <h1>{{ offer.name }} - {% trans 'Special prices and display options' %}</h1>
  </div>
{% endblock %}


{% block dashboard_content %}
  <div class="row mb-5">
    <div class="col-12 col-md-8 col-lg-5 bg-white">
      {{ form.media }}
      {% include 'oscar/dashboard/partials/form.html' with style='horizontal'%}
    </div>
    <div class="col-12 col-lg-7">
      <img id="slide-preview" style="cursor: crosshair;" draggable="false" ondragstart="return false;" src="{% thumbnail form.instance.cached_slide 800x533 quality=90 %}" class="img-thumbnail w-100">
      <div  id="slide-preview-spinner" class="justify-content-center bg-white w-100 h-100 position-absolute" style="display:flex;top:0;left:0;opacity:0.9;">
        <div class="spinner-border m-auto" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


{% block extrascripts %}
  {{ block.super }}
  <script>
	var currentProductPageRequest = null;
	function reloadPreview(){
		$('#slide-preview-spinner').show();
		var form = $('form');
	    var formData = {
	        'csrfmiddlewaretoken'  : form.find('input[name=csrfmiddlewaretoken]').val(),
	    };
	    currentProductPageRequest = $.ajax({
	        type: 'POST',
	        url: '{% url "dashboard:slide-preview" range_pk=offer.benefit.range.pk %}',
	        data: form.serialize(),
		    beforeSend : function()    {           
		        if(currentProductPageRequest != null) {
		            currentProductPageRequest.abort();
		        }
		    },
	    	success: function(data){
    	    	$('#slide-preview').attr('src', data);
    	        window.onbeforeunload = function() {
    	            return "Diese Seite bittet Sie zu bestätigen, dass Sie die Seite verlassen möchten – Daten, die Sie eingegeben haben, werden unter Umständen nicht gespeichert.";
    	        }
			}
	    }).done(function (){
        	$('#slide-preview-spinner').hide();
	    })
	}
	$('#slide-preview-spinner').hide();
  	$(':submit').click(function (){window.onbeforeunload=false;})
  	$('.preview-trigger').change(function (){
  		reloadPreview();
  	})
  	$('#slide-preview').click(function (e){
        e.preventDefault();
  		$('#slide-preview-spinner').show();
        var img = $('#slide-preview');
        var offset = img.offset();

		if ($('#id_sub_title').val()){
          var width_ratio = parseFloat('{{ subtitled_width_ratio|safe }}');
		}else{
          var width_ratio = parseFloat('{{ width_ratio|safe }}');
		}
		console.log(width_ratio);
        var marginX = (img.outerWidth() - img.width()) / 2;
        var x = e.pageX - marginX - offset.left;
        x = x / img.width() * 100;
        x = x / width_ratio;
        if (x < 0){
        	x = 0;
        } else if (x > 100){
        	x = 100;
        }

		if ($('#id_sub_title').val()){
          var height_ratio = parseFloat('{{ subtitled_height_ratio|safe }}');
		}else{
	  	  var height_ratio = parseFloat('{{ height_ratio|safe }}');
		}
		console.log(height_ratio);
        var marginY = (img.outerHeight() - img.height()) / 2;
        var y = e.pageY - marginY - offset.top;
        y = y / img.height() * 100;
        y = y / height_ratio;
        if (y < 0){
        	y = 0;
        } else if (y > 100){
        	y = 100;
        }

        $('#id_left').val(x);
        $('#id_top').val(y);
        reloadPreview();
  	})
  </script>
{% endblock %}

