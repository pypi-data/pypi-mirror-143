"use strict";(self.webpackChunktvb_ext_unicore=self.webpackChunktvb_ext_unicore||[]).push([[67],{67:(t,e,i)=>{i.r(e),i.d(e,{default:()=>_});var n,a=i(504),s=i(149),o=i(706);class d extends o.Widget{constructor(t,e,i,a){super(),this._awaitingOperation=!1,this._lastUpdateTime=new Date,this.layout=new o.PanelLayout,this._loadingRoot=document.createElement("div"),this._loadingRoot.id="loadingRoot",this._loadingRoot.classList.add("lm-Widget","p-Widget","loadingRoot"),this.node.appendChild(this._loadingRoot),this.addClass("tvb-pyunicoreWidget"),this.buttonSettings=i,this.getData=a,this.table=document.createElement("table"),this.tHead=document.createElement("thead"),this.tBody=document.createElement("tbody"),this.table.appendChild(this.tHead),this.table.appendChild(this.tBody),this.node.appendChild(this.table),this.tableFormat=t,this._data=e,this.buildTable(),this._modal=new r(n.Error,"Unknown Error"),this.node.appendChild(this._modal.node),this._updateIntervalId=setInterval((()=>this._onTriggerUpdateInterval()),1e4),this._pagination=this._createPagination(),this.layout.addWidget(this._pagination)}get pagination(){return this._pagination}get data(){return this._data}set data(t){this._data=t,this.buildTBody()}_createPagination(){return new h((()=>{this.update()}),(()=>{this.update()}))}buildTable(){this.tHead.innerHTML="",this.buildTHead(),this.buildTBody()}buildTHead(){const t=document.createElement("tr");this.tHead.appendChild(t),this.tableFormat.cols.forEach((e=>{const i=document.createElement("th");i.innerText=e.toUpperCase(),t.appendChild(i)}));const e=document.createElement("th");e.innerText="ACTIONS",t.appendChild(e)}buildTBody(){this.tBody.innerHTML="",this.data.jobs.forEach((t=>{const e=document.createElement("tr");e.id=t[this.tableFormat.idField],this.tableFormat.cols.forEach((i=>{const n=document.createElement("td");n.innerText=t[i],n.classList.add(i),e.appendChild(n)}));const i=this._getBuiltButton(t),n=document.createElement("td");n.id=`action-${t[this.tableFormat.idField]}`,n.classList.add("actions"),t[this.tableFormat.buttonRenderConditionField]&&n.appendChild(i),e.appendChild(n),this.tBody.appendChild(e);const a=this._getBuiltDetailsSection(t);this.tBody.appendChild(a),e.onclick=()=>d._toggleDisplay(a)}))}static _toggleDisplay(t){t.style.display="none"===t.style.display?"revert":"none"}_getBuiltDetailsSection(t){const e=document.createElement("tr");e.id=`details-${t[this.tableFormat.idField]}`,e.classList.add("detailsRow");const i=document.createElement("td");e.appendChild(i);let n="";return n=(null==t?void 0:t.logs)?t.logs.join("\n"):"No logs for this job!",i.innerHTML=`<textarea>${n}</textarea>`,i.colSpan=100,e.style.display="none",e}_getBuiltButton(t){const e=document.createElement("button");e.innerText=this.buttonSettings.name;const i=this.buttonSettings.onClickFieldArgs.map((e=>t[e]));return e.onclick=()=>{this.buttonSettings.isAsync?(this._showBtnLoader(`action-${t[this.tableFormat.idField]}`),this.buttonSettings.onClick(...i).then((e=>{e.job?(this._reRenderRowWithData(t[this.tableFormat.idField],e.job),this._reRenderRowDetailsSection(`details-${t[this.tableFormat.idField]}`,e.job)):this._reRenderRowWithData(t[this.tableFormat.idField],t),this._showMessage(this._loadingRoot.id,e.message)})).catch((e=>{this.showModal(n.Error,e),this._reRenderRowWithData(t[this.tableFormat.idField],t)}))):this.buttonSettings.onClick(...i)},e}_reRenderRowDetailsSection(t,e){const i=this.node.querySelector(`#${t}`);i&&(i.innerHTML=`<td colspan="100"><textarea>${e.logs.join("\n")}</textarea></td>`)}showModal(t,e){this._modal.type=t,this._modal.message=e,this._modal.showModal()}_showBtnLoader(t){const e=document.getElementById(t);e&&(e.innerHTML="<div class='unicoreLoading'></div>")}_showMessage(t,e){const i=document.getElementById(t),n=`<span class="unicoreMessage">${e}</span>`;i&&(i.innerHTML=n)}_reRenderRowWithData(t,e){const i=document.getElementById(t);if(!i)return;this.tableFormat.cols.forEach((t=>{const n=i.querySelector(`.${t}`);n&&(n.innerHTML=e[t])}));const n=i.querySelector(".actions");n&&(n.innerHTML=""),e[this.tableFormat.buttonRenderConditionField]&&n&&n.appendChild(this._getBuiltButton(e))}async onUpdateRequest(t){super.onUpdateRequest(t),this._awaitingOperation||(this._pagination.disableButtons(),this._disableSelection(),this._showBtnLoader(this._loadingRoot.id),this._awaitingOperation=!0,this.getData(String(this._pagination.page)).then((t=>{var e;this.data=t,this._clearInnerHtmlById(this._loadingRoot.id),this._showMessage(this._loadingRoot.id,t.message);const i=document.createElement("span");i.innerHTML=`Last update: ${this._lastUpdateTime.toLocaleString()}`,null===(e=document.getElementById(this._loadingRoot.id))||void 0===e||e.appendChild(i),t.jobs.length<this._pagination.itemsPerPage?this._pagination.enablePrevBtn():this._pagination.enableButtons(),this._awaitingOperation=!1,this._lastUpdateTime=new Date,this._enableSelection()})).catch((t=>{console.log(t),this.showModal(n.Error,t),this._clearInnerHtmlById(this._loadingRoot.id),this._awaitingOperation=!1,this._enableSelection()})))}_disableSelection(){const t=this.node.querySelectorAll("select");t&&t.forEach((t=>t.setAttribute("disabled","disabled")))}_enableSelection(){const t=this.node.querySelectorAll("select");t&&t.forEach((t=>t.removeAttribute("disabled")))}_clearInnerHtmlById(t){const e=document.getElementById(t);e&&(e.innerHTML="")}_onTriggerUpdateInterval(){(new Date).valueOf()-this._lastUpdateTime.valueOf()>=6e4&&this.update()}onAfterDetach(t){super.onAfterDetach(t),clearInterval(this._updateIntervalId)}}class l extends o.Widget{constructor(t){super(),this.addClass("pyunicoreSites"),this.sites=t,this._label=document.createElement("span"),this._label.innerText="Site:",this._activeSite=t.length>0?t[0]:"";const e=document.createElement("div");e.appendChild(this._label),this._select=document.createElement("select"),e.appendChild(this._select),this.node.appendChild(e),this._select.onchange=()=>{this._activeSite=this._select.value,this.changeHandler()},this._buildSelection()}get activeSite(){return this._activeSite}_buildSelection(){this.sites.forEach((t=>{const e=document.createElement("option");e.id=t,e.value=t,e.innerText=t,this._select.appendChild(e)}))}changeHandler(){}}!function(t){t.Warning="WARNING",t.Error="ERROR",t.Success="SUCCESS",t.Confirm="CONFIRM"}(n||(n={}));class r extends o.Widget{constructor(t,e){super(),this._type=t,this._message=e,this._modalHeader=document.createElement("div"),this._modalBody=document.createElement("div"),this._modalFooter=document.createElement("div"),this.addClass("unicoreModal"),this._buildModal()}get type(){return this._type}set type(t){this._type=t,this._buildModalHeader()}get message(){return this._message}set message(t){this._message=t,this._buildModalBody()}_buildModal(){this.node.style.display="none";const t=document.createElement("div");t.appendChild(this._modalHeader),this._buildModalHeader(),t.appendChild(this._modalBody),this._buildModalBody(),t.appendChild(this._modalFooter),this._buildModalFooter(),this.node.innerHTML="",this.node.appendChild(t)}_buildModalHeader(){this._modalHeader.innerHTML="";const t=document.createElement("h3");t.innerText=this._type,this._modalHeader.appendChild(t)}_buildModalBody(){this._modalBody.innerHTML="";const t=document.createElement("p");t.innerText=this._message,this._modalBody.appendChild(t)}_buildModalFooter(){this._modalFooter.innerHTML="";const t=document.createElement("button");t.innerText="CLOSE",t.onclick=()=>this.hideModal(),this._modalFooter.appendChild(t)}hideModal(){this.node.style.display="none"}showModal(){this.node.style.display="flex"}}class h extends o.Widget{constructor(t,e,i){super(i),this._itemsPerPage=10,this._prevButton=document.createElement("button"),this._nextButton=document.createElement("button"),this.addClass("unicorePagination"),this._page=1,this._currentPage=document.createElement("span"),this._currentPage.innerText="Page: "+String(this._page),this._onNextPage=t,this._onPreviousPage=e,this._buildUi()}get itemsPerPage(){return this._itemsPerPage}get page(){return this._page}set page(t){this._page=t,this._currentPage.innerText="Page: "+String(this._page)}_buildUi(){this.node.innerHTML="";const t=document.createElement("div"),e=document.createElement("div");e.classList.add("btnLeftContainer");const i=document.createElement("div");i.classList.add("currentPageContainer");const n=document.createElement("div");n.classList.add("btnRightContainer"),this.node.appendChild(t),this._prevButton.onclick=()=>this.previousPage(),t.appendChild(e),e.appendChild(this._prevButton),i.appendChild(this._currentPage),t.appendChild(i),n.appendChild(this._nextButton),t.appendChild(n),this._nextButton.innerHTML='<i class="fa fa-arrow-right"></i>',this._prevButton.innerHTML='<i class="fa fa-arrow-left"></i>',this._nextButton.onclick=()=>this.nextPage()}nextPage(){this.page+=1,this._onNextPage()}previousPage(){this.page-=1,this._onPreviousPage()}disablePrevBtn(){this._prevButton.disabled=!0,this._prevButton.style.display="none"}enablePrevBtn(){1!==this._page&&(this._prevButton.disabled=!1,this._prevButton.style.display="inline-block")}disableNextBtn(){this._nextButton.disabled=!0,this._nextButton.style.display="none"}enableNextBtn(){this._nextButton.disabled=!1,this._nextButton.style.display="inline-block"}disableButtons(){this.disablePrevBtn(),this.disableNextBtn()}enableButtons(){this.enablePrevBtn(),this.enableNextBtn()}}var c=i(626),u=i(695);async function p(t="",e={}){const i=u.ServerConnection.makeSettings(),n=c.URLExt.join(i.baseUrl,"tvbextunicore",t);let a;try{a=await u.ServerConnection.makeRequest(n,e,i)}catch(t){throw new u.ServerConnection.NetworkError(t)}let s=await a.text();if(s.length>0)try{s=JSON.parse(s)}catch(t){console.log("Not a JSON response body.",a)}if(!a.ok)throw new u.ServerConnection.ResponseError(a,s.message||s);return s}async function m(t){const e={resource_url:t};return p("jobs",{method:"POST",body:JSON.stringify(e)})}const _={id:"tvbextunicore:plugin",autoStart:!0,requires:[s.ICommandPalette,a.ILayoutRestorer],activate:async(t,e,i)=>{let n;console.log("JupyterLab extension tvb-ext-unicore is activated!");const a=["id","name","owner","site","status","start_time"],o="tvbextunicore:open";t.commands.addCommand(o,{label:"PyUnicore Task Stream",execute:async()=>{if(!n||n.isDisposed){const t=await p("sites"),e=new l(t),i=new d({cols:a,idField:"id",buttonRenderConditionField:"is_cancelable"},{jobs:[],message:""},{name:"Cancel Job",onClick:m,onClickFieldArgs:["resource_url"],isAsync:!0},(async t=>{let i=`jobs?site=${e.activeSite}`;return t&&(i+=`&page=${t}`),await p(i)}));e.changeHandler=()=>{i.pagination.page=1,i.update()},i.layout.addWidget(e),n=new s.MainAreaWidget({content:i}),n.id="tvbextunicore",n.title.label="PyUnicore Task Stream",n.title.closable=!0}r.has(n)||r.add(n),n.isAttached||t.shell.add(n,"main"),t.shell.activateById(n.id)}}),e.addItem({command:o,category:"PyUnicore"});const r=new s.WidgetTracker({namespace:"pyunicore"});i.restore(r,{command:o,name:()=>"pyunicore"})}}}}]);